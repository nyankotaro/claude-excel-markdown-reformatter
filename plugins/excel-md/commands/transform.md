---
description: Excel Markdown 変換処理
argument-hint: "<transform_prompt.md>"
---

# Excel Markdown 変換処理

sheet-transformerサブエージェント並列実行による大容量シート処理を実行し、シート別改良マークダウンファイルを生成します。

## 処理指示

### 1. 変換プロンプトの読み込み
- $ARGUMENTSで指定されたファイルからbasenameを抽出
- `{basename}_transform_prompt.md` を読み込み、変換指示を取得
- 元ファイルをReadして ## レベルでシート分割を実行

### 2. シートデータの抽出
- `{basename}.md` を `##` レベルヘッダーで分割
- 各シートのraw markdownテキストを個別に抽出
- シート名と出現順番号を記録

### 3. sheet-transformerサブエージェント並列起動

#### 並列起動の必須ルール
- 各シートに対して1つのTask Tool呼び出しを作成する
- `subagent_type: "sheet-transformer"` を指定する
- 依存関係のない複数のTask Tool呼び出しは、**必ず同一ターン内（単一メッセージ内）で全サブエージェント呼び出しを並列発行すること**
- シート数≤5: 全シートを1回の並列発行で実行
- シート数>5: 5シートずつバッチ化し、バッチ完了後に次バッチを発行

#### 各サブエージェントへのプロンプト構成
promptには以下を全て含む自己完結したテキストを渡す（親コンテキストへの暗黙参照を避ける）:
1. 「以下のシートを変換してください」という明確な指示
2. 出力ファイルパス: `{basename}_sheet_{2桁番号}_{シート名}.md`
3. シート名
4. 対象シートのraw markdownテキスト全文（`##` ヘッダーからの抽出済み）

#### プロンプトテンプレート
各サブエージェントに渡すプロンプトは以下の形式:
```
以下のシートを変換してください。

出力ファイルパス: {output_path}
シート名: {sheet_name}

変換対象のraw markdownテキスト:
---
{raw_markdown_content}
---
```

#### バッチ実行パターン

##### シート数≤5の場合
全シートのTask Tool呼び出しを同一メッセージで発行する。

##### シート数>5の場合
```
バッチ1: シート1-5のTask Tool呼び出しを同一メッセージで発行
→ バッチ1の全Task完了を待機
バッチ2: シート6-10のTask Tool呼び出しを同一メッセージで発行
→ バッチ2の全Task完了を待機
...全シート完了まで繰り返し
```

### 4. ファイル保存と品質管理

#### ファイル命名規則の厳守
- `{basename}_sheet_{2桁番号}_{シート名}.md`
- 番号はシート出現順で01, 02, 03...
- シート名の不正文字は "_" に置換

#### 不要ファイル生成の監視・禁止
- test_*, debug_*, sample_* パターンファイルの生成を検出・阻止
- 命名規則外ファイル作成時の即座停止
- 各サブエージェント完了時のファイル確認

### 5. 変換完了の確認と報告
- 全サブエージェント完了の確認
- 生成されたシート別ファイル一覧の表示（Globで `{basename}_sheet_*.md` を検索）
- 欠落シートがあれば警告を表示
- エラー・警告の集約表示
- 次ステップ（merge コマンド）の実行指示

## データ保持原則

**サブエージェント内での厳格な制約**:
- 元セル値の変更・推測・補完を一切禁止
- 装飾追加（ボールド、イタリック等）を禁止
- 情報追加を完全禁止（元データのみ使用）
- Writeツールによる完全ファイル生成まで各サブエージェント内で実行

## 厳格禁止事項

**処理回避・手抜きの完全禁止**:
- 「元ファイル参照」形式での処理回避の絶対禁止
- 「（詳細は元ファイル行XXX-YYYを参照）」記述の完全禁止
- 「（〜の詳細は〜を参照）」パターンの一切禁止
- 時間短縮目的での手抜き処理の禁止
- 各シートファイルの独立性違反の禁止

**必須実行事項**:
- 全シートの実データ変換の完全実行
- NaN/Unnamed除去の実際の処理実装
- 各ファイルが元ファイル参照なしで完結
- すべてのシートデータの完全変換処理

## エラー処理

- サブエージェント利用不可時: 5シート順次処理フォールバック（直接Read/Write）
- 個別サブエージェント失敗時: 再実行または手動修正指示
- ファイル保存エラー時: 代替パス確認
- バッチ処理中断時: 部分完了状態からの復旧

## 実行例

```bash
/excel-md:transform sample_data.md
```

変換完了後、`sample_data_sheet_01_表紙.md`、`sample_data_sheet_02_目次.md` 等のファイル群が生成され、merge コマンドでの統合準備が整います。
