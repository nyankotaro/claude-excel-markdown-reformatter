# Excel Markdown 統合処理

シート別ファイル群を統合し、最終品質検証を実行して完成マークダウンファイルを生成します。

## 処理指示

### 1. シート別ファイルの収集
- $ARGUMENTSで指定されたbasenameから関連ファイル群を特定
- `{basename}_sheet_*.md` パターンでシート別ファイルを検索・収集
- ファイル名の2桁番号順でソートし、シート出現順序を保持

### 2. ファイル統合処理

#### 2.1 順次結合実行
- ファイル番号順（01, 02, 03...）で統合処理を実行
- 各シートの ## レベルヘッダーを保持
- シート間に適切な区切りを維持

#### 2.2 統合ルール
- 各シートの改良済み内容を順次結合
- 重複見出しや空セクションの除去
- 全体の一貫性と読みやすさの確保

### 3. 品質検証の実行

#### 3.1 マークダウン構文検証
- CommonMark仕様への準拠確認
- テーブル構文の正しさ検証
- 見出し階層の適切性チェック
- エスケープ処理の確認

#### 3.2 情報保持検証
- 元コンテンツとの差分チェック
- 情報の欠損・追加の検出
- セル値変更の監視
- 意味的内容の維持確認

#### 3.3 構造一貫性チェック
- テーブル構造の統一性
- 見出しレベルの適切性
- 全体の論理的な流れ

### 4. 最終ファイル生成

#### 4.1 ファイル保存
- `{basename}_reformed.md` として最終ファイルを保存
- UTF-8エンコーディングでの保存
- 改行コードの統一（LF）

#### 4.2 メタデータ付与
統合ファイルの先頭に以下の情報を追加：
```markdown
<!-- Excel Markdown Reformatter で生成 -->
<!-- 元ファイル: {basename}.md -->
<!-- 生成日時: {timestamp} -->
<!-- シート数: {sheet_count} -->
```

### 5. 品質レポートの生成・表示

#### 5.1 統計情報
- 処理済みシート数
- 総行数・テーブル数
- 除去されたNaN/Unnamed数
- ファイルサイズの比較

#### 5.2 品質スコア
- マークダウン標準準拠: [0-100%]
- 情報保持率: [0-100%]
- 可読性向上度: [改良前後の比較]

#### 5.3 警告・注意事項
- データ損失の可能性がある箇所
- 手動確認が推奨される部分
- 使用時の注意点

### 6. クリーンアップと完了

#### 6.1 中間ファイル管理
- シート別ファイル群の保持（削除しない）
- 変換プロンプトファイルの保持
- 不要ファイル（test_*, debug_*等）の除去確認

#### 6.2 完了報告
- 最終ファイル生成の確認
- ファイルパスと場所の表示
- 品質検証結果の要約
- 使用方法の簡単な説明

## データ保持原則

**統合時の厳格な制約**:
- 元データの意味的内容を完全保持
- セル値の変更・推測・補完を絶対禁止
- 装飾追加を禁止（構造整形のみ）
- 情報追加を完全禁止
- マークダウン標準準拠の構造整形のみ実行

## 品質検証基準

### CommonMark準拠
- テーブル構文の正確性
- 見出し階層の適切性
- エスケープ処理の正しさ

### 情報保持原則
- 元コンテンツの意味保持
- データ欠損の完全回避
- 情報追加の厳格禁止

### 可読性向上
- 構造化された階層
- 整形されたテーブル表示
- 論理的な情報の流れ

## 実行例

```bash
/excel-md:merge sample_data
```

統合完了後、`sample_data_reformed.md` が生成され、品質検証レポートが表示されます。元のシート別ファイル群は保持され、必要に応じて個別参照可能です。