# Excel Markdown 変換処理

Task Tool並列実行による大容量シート処理を実行し、シート別改良マークダウンファイルを生成します。

## 処理指示

### 1. 変換プロンプトの読み込み
- $ARGUMENTSで指定されたファイルからbasenameを抽出
- `{basename}_transform_prompt.md` を読み込み、変換指示を取得
- 元ファイルをReadして ## レベルでシート分割を実行

### 2. 並列実行方式の決定
シート数に応じてTask Tool並列実行を制御：
- **シート数≤5**: 単一バッチで全シート並列実行
- **シート数>5**: 5シートごと分割バッチ実行（1-5, 6-10, 11-15...）
- **最大並列度**: 5シート（1シート=1Task）

### 3. Task並列実行の実装

#### 単一バッチ実行（シート数≤5）
```markdown
Task Toolを使用して以下の並列実行を開始：

Task 1: シート1個別変換
Task 2: シート2個別変換
...
Task N: シートN個別変換（最大5個）

各Taskでは以下を必須実行：
- 指定シート1つの完全なデータ変換（参照形式禁止）
- NaN/Unnamed除去の実際の処理実装
- マークダウンテーブル整形の完全実行
- {basename}_sheet_{2桁番号}_{シート名}.md でのWriteツール保存
```

#### 5シートごと分割実行（シート数>5）
```markdown
バッチ1: Task Tool で1-5シート並列実行（Task1-5）
バッチ1完了確認後
バッチ2: Task Tool で6-10シート並列実行（Task6-10）
バッチ2完了確認後
バッチ3: Task Tool で11-15シート並列実行（Task11-15）
...
全バッチ完了まで繰り返し
```

### 4. 個別シート変換指示

各Taskに以下の処理を指示：

#### 4.1 完全データ変換（参照形式絶対禁止）
- "NaN" セル値の完全除去（空セルに変換）
- "Unnamed: \d+" 列ヘッダーの完全除去
- 空行・空列の実際の整理処理
- 「（詳細は〜を参照）」パターンの作成絶対禁止

#### 4.2 マークダウンテーブル実装整形
- 有効なデータのみでテーブル構造を実際に構築
- 列ヘッダーと罫線の適切な配置の実装
- セル内改行の処理（`<br>` 変換）の実行
- 完全な独立ファイルとしての機能保証

#### 4.3 見出し階層の実装設定
- シート名を ## レベルヘッダーとして実際に設定
- 元データ構造に基づく階層の実際の適用
- 推測による見出し追加の禁止
- 元ファイル参照なしでの完結性保証

### 5. ファイル保存と品質管理

#### ファイル命名規則の厳守
- `{basename}_sheet_{2桁番号}_{シート名}.md`
- 番号はシート出現順で01, 02, 03...
- シート名の不正文字は "_" に置換

#### 不要ファイル生成の監視・禁止
- test_*, debug_*, sample_* パターンファイルの生成を検出・阻止
- 命名規則外ファイル作成時の即座停止
- 各Task完了時のファイル確認

### 6. 変換完了の確認と報告
- 全Task完了の確認
- 生成されたシート別ファイル一覧の表示
- エラー・警告の集約表示
- 次ステップ（merge コマンド）の実行指示

## データ保持原則

**Task内での厳格な制約**:
- 元セル値の変更・推測・補完を一切禁止
- 装飾追加（ボールド、イタリック等）を禁止
- 情報追加を完全禁止（元データのみ使用）
- Writeツールによる完全ファイル生成まで各Task内で実行

## 厳格禁止事項

**処理回避・手抜きの完全禁止**:
- 「元ファイル参照」形式での処理回避の絶対禁止
- 「（詳細は元ファイル行XXX-YYYを参照）」記述の完全禁止
- 「（〜の詳細は〜を参照）」パターンの一切禁止
- 時間短縮目的での手抜き処理の禁止
- 各シートファイルの独立性違反の禁止

**必須実行事項**:
- 全シートの実データ変換の完全実行
- NaN/Unnamed除去の実際の処理実装
- 各ファイルが元ファイル参照なしで完結
- すべてのシートデータの完全変換処理

## エラー処理

- Task Tool利用不可時の5シート順次処理フォールバック
- 個別Task失敗時の再実行または修正指示
- ファイル保存エラー時の代替パス確認
- バッチ処理中断時の部分完了状態からの復旧

## 実行例

```bash
/excel-md:transform sample_data.md
```

変換完了後、`sample_data_sheet_01_表紙.md`、`sample_data_sheet_02_目次.md` 等のファイル群が生成され、merge コマンドでの統合準備が整います。