# Excel Markdown 準備処理

markitdownで生成されたExcelマークダウンファイルを解析し、変換用プロンプトを生成します。

## 処理指示

### 1. ファイル読み込みと基本検証
- $ARGUMENTSで指定されたファイルをReadツールで読み込む
- ファイルの存在確認とmarkitdown形式の基本検証
- ファイルサイズとシート数の概算を表示

### 2. シート構造の解析
- ## レベルヘッダーでシート境界を識別し、シート一覧を抽出
- 各シートについて以下を分析：
  - シート名とデータ範囲の特定
  - NaN値とUnnamed列のカウント
  - テーブル構造の複雑度判定
  - データ品質問題パターンの特定

### 3. 変換戦略の決定
- シート数による並列処理方式の判定（≤5: 単一バッチ、>5: 5シートごと分割バッチ）
- 各シートの個別処理アプローチの決定（1シート=1Task）
- 品質問題の重要度評価と対処方針の設定

### 4. 変換プロンプトの生成と保存
- 分析結果を基に詳細な変換指示プロンプトを生成
- ファイル名から basename を抽出
- `{basename}_transform_prompt.md` として変換プロンプトを保存
- プロンプトには以下を含める：
  - **1シート=1Task方式**: 各シートの個別処理指示（グループ化しない）
  - 各シートのNaN/Unnamed除去の具体的なパターン
  - シートごとのテーブル整形の品質基準
  - ファイル保存時の命名規則（{basename}_sheet_{2桁番号}_{シート名}.md）
  - **厳格禁止事項**: 参照形式処理回避の完全禁止指示
  - **必須実行事項**: 全データ実変換の完全実行指示
  - **見出しレベル制御**: 各Task内でシート名を ## レベル（h2）で記述し、シート内見出しは ### レベル（h3）以下のみ使用する明示的指示

### 5. 分析結果の要約表示
- 検出されたシート数と主要な問題パターン
- 推定処理時間と並列実行方式（5シートごとバッチ）
- 生成された1シート=1Task処理指示の確認
- 次ステップ（transform コマンド）の実行指示

## データ保持原則

**厳格な制約**:
- 元ファイルの各セル値を一文字も変更しない
- 推測による情報補完を完全禁止
- 存在しないコンテンツ追加の絶対禁止
- 装飾（ボールド、イタリック等）追加の禁止
- 構造整形とマークダウンテーブル生成のみ許可

## 変換プロンプト生成制約

**生成プロンプトに必須含有事項**:
- 「元ファイル参照」形式での処理回避の絶対禁止指示
- 「（詳細は〜を参照）」パターンの完全禁止指示
- 時間短縮目的での手抜き処理の禁止指示
- 各シートファイルの独立性保持の必須指示
- 全シートデータの完全変換処理の必須実行指示
- 見出しレベル厳守: シート名は必ず ## レベル（h2）で記述し、シート内の全ての見出しは ### レベル（h3）以下のみ使用することの必須指示

## 実行例

```bash
/excel-md:prepare sample_data.md
```

分析完了後、`sample_data_transform_prompt.md` が生成され、transform コマンドでの使用準備が整います。